<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC
        "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
        "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">

<!-- 
    ========================================================================
    * Copyright (c) 2008 Civic Computing Ltd.
    * All rights reserved.
    *
    * Revision      $$Rev$$
    * Modified by   $$Author$$
    * Modified on   $$Date$$
    *
    * Changes: see SubVersion log.
    ========================================================================
-->
<hibernate-mapping default-access="field">
    <database-object>
        <create>
        CREATE TABLE DATA(
            ID VARCHAR(255) NOT NULL,
            VERSION INTEGER NOT NULL,
            BYTES BLOB NOT NULL
        )
        </create>
        <drop>DROP TABLE data</drop>
        <dialect-scope name="org.hibernate.dialect.H2Dialect"/>
        <dialect-scope name="org.hibernate.dialect.Oracle9Dialect"/>
        <dialect-scope name="org.hibernate.dialect.MySQL5InnoDBDialect"/>
    </database-object>
    <database-object>
        <create>
        CREATE TABLE DATA(
            ID VARCHAR(255) NOT NULL,
            VERSION INTEGER NOT NULL,
            BYTES varbinary(max) NOT NULL
        )
        </create>
        <drop>DROP TABLE data</drop>
        <dialect-scope name="org.hibernate.dialect.SQLServerDialect"/>
    </database-object>
    
    <database-object>
        <create>
        CREATE SEQUENCE LOG_ENTRY_INDEX
        START WITH 1
        INCREMENT BY 1
        CACHE 0
        </create>
        <drop>DROP SEQUENCE LOG_ENTRY_INDEX</drop>
        <dialect-scope name="org.hibernate.dialect.H2Dialect"/>
    </database-object>
    <database-object>
        <create>
        CREATE SEQUENCE LOG_ENTRY_INDEX
        START WITH 1
        INCREMENT BY 1
        </create>
        <drop>DROP SEQUENCE LOG_ENTRY_INDEX</drop>
        <dialect-scope name="org.hibernate.dialect.Oracle9Dialect"/>
    </database-object>
    
    <database-object>
        <create>
        BEGIN
            ALTER TABLE logentries DROP COLUMN idx
            ALTER TABLE logentries ADD idx numeric(19,0) IDENTITY(1,1)
        END
        </create>
        <drop/>
        <dialect-scope name="org.hibernate.dialect.SQLServerDialect"/>
    </database-object>
    <database-object>
        <create>
        ALTER TABLE logentries
        ALTER COLUMN index_position SET DEFAULT nextval('LOG_ENTRY_INDEX')
        </create>
        <drop/>
        <dialect-scope name="org.hibernate.dialect.H2Dialect"/>
    </database-object>
    <database-object>
        <create>
        create or replace trigger logentry_autonumber
        before insert on logentries for each row
        begin
            select LOG_ENTRY_INDEX.nextval into :new.idx from dual;
        end;
        </create>
        <drop>drop trigger logentry_autonumber</drop>
        <dialect-scope name="org.hibernate.dialect.Oracle9Dialect"/>
    </database-object>
    <database-object>
        <create>
        ALTER TABLE logentries
        CHANGE COLUMN _INDEX _INDEX bigint(20) NOT NULL AUTO_INCREMENT UNIQUE
        </create>
        <drop/>
        <dialect-scope name="org.hibernate.dialect.MySQL5InnoDBDialect"/>
    </database-object>
    
    <database-object>
        <create>
        BEGIN
            ALTER TABLE logentries DROP COLUMN RECORDEDON
            ALTER TABLE logentries ADD RECORDEDON datetime DEFAULT CURRENT_TIMESTAMP
        END
        </create>
        <drop/>
        <dialect-scope name="org.hibernate.dialect.SQLServerDialect"/>
    </database-object>
    <database-object>
        <create>
        ALTER TABLE logentries
        ALTER COLUMN recorded_on SET DEFAULT CURRENT_TIMESTAMP() 
        </create>
        <drop/>
        <dialect-scope name="org.hibernate.dialect.H2Dialect"/>
    </database-object>
    <database-object>
        <create>
        CREATE TRIGGER logentry_timestamp
        before INSERT ON logentries FOR EACH ROW
        begin
            select systimestamp into :new.RECORDEDON from dual;
        END;
        </create>
        <drop>drop trigger logentry_timestamp</drop>
        <dialect-scope name="org.hibernate.dialect.Oracle9Dialect"/>
    </database-object>
    <database-object>
        <create>
        ALTER TABLE logentries
        CHANGE COLUMN _RECORDEDON _RECORDEDON TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        </create>
        <drop/>
        <dialect-scope name="org.hibernate.dialect.MySQL5InnoDBDialect"/>
    </database-object>
</hibernate-mapping>
